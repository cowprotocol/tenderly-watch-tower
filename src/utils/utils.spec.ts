import * as composableCow from "../../abi/ComposableCoW.json";
import * as extensibleFallbackHandler from "../../abi/ExtensibleFallbackHandler.json";
import {
  ORDER_NOT_VALID_SELECTOR,
  SINGLE_ORDER_NOT_AUTHED_SELECTOR,
  isComposableCowCompatible,
  parseCustomError,
} from ".";

// consts for readability
const composableCowBytecode = composableCow.deployedBytecode.object;
const failBytecode = extensibleFallbackHandler.deployedBytecode.object;

describe("test supports composable cow interface from bytecode", () => {
  it("should pass", () => {
    expect(isComposableCowCompatible(composableCowBytecode)).toBe(true);
  });

  it("should fail", () => {
    expect(isComposableCowCompatible(failBytecode)).toBe(false);
  });
});

describe("test against concrete examples", () => {
  const signatures = ["0x1c7662c8", "0x26e0a196"];

  it("should pass with both selectors", () => {
    expect(isComposableCowCompatible("0x1c7662c826e0a196")).toBe(true);
  });

  // using `forEach` here, be careful not to do async tests.
  signatures.forEach((s) => {
    it(`should fail with only selector ${s}`, () => {
      expect(isComposableCowCompatible(s)).toBe(false);
    });
  });

  it("should fail with no selectors", () => {
    expect(isComposableCowCompatible("0xdeadbeefdeadbeef")).toBe(false);
  });
});

describe("handle nethermind reversion (simple)", () => {
  it("should pass the SingleOrderNotAuthed selector correctly", () => {
    expect(parseCustomError(SINGLE_ORDER_NOT_AUTHED_ERROR)).toMatchObject({
      errorNameOrSelector: SINGLE_ORDER_NOT_AUTHED_SELECTOR,
    });
  });

  it("should pass the OrderNotValid selector correctly", () => {
    expect(parseCustomError(ORDER_NOT_VALID_NOT_NETHERMIND)).toMatchObject({
      errorNameOrSelector: ORDER_NOT_VALID_SELECTOR,
      message: "after twap finish",
    });
  });

  it("should fail if some other error is passed", () => {
    expect(parseCustomError(ARBITRARY_REVERT_WITH_PARAMETERS)).toMatchObject(
      {}
    ); // empty object
  });

  it("should pass the OrderNotValid selector correctly from nethermind", () => {
    expect(parseCustomError(ORDER_NOT_VALID_NETHERMIND)).toMatchObject({
      errorNameOrSelector: ORDER_NOT_VALID_SELECTOR,
      message: "after twap finish",
    });
  });
});

// test data

const SINGLE_ORDER_NOT_AUTHED_ERROR = {
  reason:
    "missing revert data in call exception; Transaction reverted without a reason string",
  code: "CALL_EXCEPTION",
  data: "0x",
  transaction: {
    to: "0xfdaFc9d1902f4e0b84f65F49f244b32b31013b74",
    data: "0x26e0a1960000000000000000000000005fbdb2315678afecb367f032d93f642f64180aa30000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000006cf1e9ca41f7611def408122793c358a3d11e5a5d116a28addff79282ce9b2e5dc78b8d11ae585440fb66bf263e3a328c9d2a1f700000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020d116a28addff79282ce9b2e5dc78b8d11ae585440fb66bf263e3a328c9d2a1f700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    accessList: null,
  },
  error: {
    reason: "processing response error",
    code: "SERVER_ERROR",
    body: '{"jsonrpc":"2.0","error":{"code":-32015,"message":"VM execution error.","data":"Reverted 0x7a933234"},"id":44}',
    error: {
      code: -32015,
      data: "Reverted 0x7a933234",
    },
  },
};

const ORDER_NOT_VALID_NOT_NETHERMIND = {
  reason: null,
  code: "CALL_EXCEPTION",
  method:
    "getTradeableOrderWithSignature(address,(address,bytes32,bytes),bytes,bytes32[])",
  data: "0xc8fc272500000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000011616674657220747761702066696e697368000000000000000000000000000000",
  errorArgs: null,
  errorName: null,
  errorSignature: null,
  address: "0xfdaFc9d1902f4e0b84f65F49f244b32b31013b74",
  args: [
    "0x6Dc48b0f065B8967F0f2271d6aB153DCdA3269F6",
    {
      handler: "0x6cF1e9cA41f7611dEf408122793c358a3d11E5a5",
      salt: "0x00000000000000000000000000000000000000000000000000000018a0398081",
      staticInput:
        "0x00000000000000000000000072e4f9f808c49a2a61de9c5896298920dc4eeea9000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000006dc48b0f065b8967f0f2271d6ab153dcda3269f600000000000000000000000000000000000000000000000000000374c1a6700000000000000000000000000000000000000000000000000029a389012aef2f690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000008700000000000000000000000000000000000000000000000000000000000000000c748f647179000fdeaff7a288564347d19ea26d0d451a943815ae4d3c0ac01c0",
    },
    "0x",
    [],
  ],
  transaction: {
    data: "0x26e0a1960000000000000000000000006dc48b0f065b8967f0f2271d6ab153dcda3269f60000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006cf1e9ca41f7611def408122793c358a3d11e5a500000000000000000000000000000000000000000000000000000018a03980810000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000014000000000000000000000000072e4f9f808c49a2a61de9c5896298920dc4eeea9000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000006dc48b0f065b8967f0f2271d6ab153dcda3269f600000000000000000000000000000000000000000000000000000374c1a6700000000000000000000000000000000000000000000000000029a389012aef2f690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000008700000000000000000000000000000000000000000000000000000000000000000c748f647179000fdeaff7a288564347d19ea26d0d451a943815ae4d3c0ac01c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    to: "0xfdaFc9d1902f4e0b84f65F49f244b32b31013b74",
  },
};

const ORDER_NOT_VALID_NETHERMIND = {
  reason:
    "missing revert data in call exception; Transaction reverted without a reason string",
  code: "CALL_EXCEPTION",
  data: "0x",
  transaction: {
    to: "0xfdaFc9d1902f4e0b84f65F49f244b32b31013b74",
    data: "0x26e0a1960000000000000000000000005fbdb2315678afecb367f032d93f642f64180aa30000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000006cf1e9ca41f7611def408122793c358a3d11e5a5d116a28addff79282ce9b2e5dc78b8d11ae585440fb66bf263e3a328c9d2a1f700000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020d116a28addff79282ce9b2e5dc78b8d11ae585440fb66bf263e3a328c9d2a1f700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    accessList: null,
  },
  error: {
    reason: "processing response error",
    code: "SERVER_ERROR",
    body: '{"jsonrpc":"2.0","error":{"code":-32015,"message":"VM execution error.","data":"Reverted 0x7a933234"},"id":44}',
    error: {
      code: -32015,
      data: "Reverted 0xc8fc272500000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000011616674657220747761702066696e697368000000000000000000000000000000",
    },
  },
};

const ARBITRARY_REVERT_WITH_PARAMETERS = {
  reason: null,
  code: "CALL_EXCEPTION",
  method:
    "getTradeableOrderWithSignature(address,(address,bytes32,bytes),bytes,bytes32[])",
  data: "0xc8fc2725deadbeefdeadbeefdeadbeefdeadbeef",
  errorArgs: null,
  errorName: null,
  errorSignature: null,
  address: "0xfdaFc9d1902f4e0b84f65F49f244b32b31013b74",
  args: [
    "0x6Dc48b0f065B8967F0f2271d6aB153DCdA3269F6",
    {
      handler: "0x6cF1e9cA41f7611dEf408122793c358a3d11E5a5",
      salt: "0x00000000000000000000000000000000000000000000000000000018a0398081",
      staticInput:
        "0x00000000000000000000000072e4f9f808c49a2a61de9c5896298920dc4eeea9000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000006dc48b0f065b8967f0f2271d6ab153dcda3269f600000000000000000000000000000000000000000000000000000374c1a6700000000000000000000000000000000000000000000000000029a389012aef2f690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000008700000000000000000000000000000000000000000000000000000000000000000c748f647179000fdeaff7a288564347d19ea26d0d451a943815ae4d3c0ac01c0",
    },
    "0x",
    [],
  ],
  transaction: {
    data: "0x26e0a1960000000000000000000000006dc48b0f065b8967f0f2271d6ab153dcda3269f60000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002600000000000000000000000006cf1e9ca41f7611def408122793c358a3d11e5a500000000000000000000000000000000000000000000000000000018a03980810000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000014000000000000000000000000072e4f9f808c49a2a61de9c5896298920dc4eeea9000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000006dc48b0f065b8967f0f2271d6ab153dcda3269f600000000000000000000000000000000000000000000000000000374c1a6700000000000000000000000000000000000000000000000000029a389012aef2f690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000008700000000000000000000000000000000000000000000000000000000000000000c748f647179000fdeaff7a288564347d19ea26d0d451a943815ae4d3c0ac01c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    to: "0xfdaFc9d1902f4e0b84f65F49f244b32b31013b74",
  },
};
